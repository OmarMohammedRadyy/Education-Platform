@model EducationPlatformN.Models.Course
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <title>دروسي - منصة عمر</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap" rel="stylesheet" />
    <link href="~/css/site.css" rel="stylesheet" />
</head>
<body>
    <div class="container-fluid">
        <header>
            <h1>منصة عمر التعليمية</h1>
            <h2>@Model.Title</h2>
        </header>
        <div class="course-info">
            <p>@Model.Description</p>
            <small>المعلم: @(Model.Teacher?.FullName ?? "غير محدد")</small>
        </div>
        <div class="row">
            <div class="col-lg-8">
                <div class="video-container">
                    @if (!string.IsNullOrEmpty(Model.IntroVideoUrl))
                    {
                        <iframe src="@GetEmbedUrl(Model.IntroVideoUrl)" allowfullscreen></iframe>
                    }
                    else if (Model.Lessons.Any())
                    {
                        <iframe src="@GetEmbedUrl(Model.Lessons.First().VideoUrl)" allowfullscreen></iframe>
                    }
                    else
                    {
                        <div class="no-content">لا يوجد محتوى متاح</div>
                    }
                </div>
                <div class="d-flex justify-content-between mt-3">
                    <button class="btn btn-primary" onclick="takeQuiz()" id="quizBtn" style="display: none;">
                        <i class="fas fa-clipboard-check"></i> اختبار الدرس
                    </button>
                    <button class="btn btn-info" onclick="openNotes()">
                        <i class="fas fa-sticky-note"></i> ملاحظات الدرس
                    </button>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="lessons-list">
                    <h5>دروس الدورة</h5>
                    @foreach (var lesson in Model.Lessons)
                    {
                        <div class="lesson-card" data-id="@lesson.LessonId" data-video="@GetEmbedUrl(lesson.VideoUrl)">
                            <h6>@lesson.Title</h6>
                            <small>المدة: @lesson.Duration</small>
                            <span class="completed-badge @(Model.StudentProgress.Any(p => p.LessonId == lesson.LessonId && p.IsCompleted) ? "" : "d-none")">
                                <i class="fas fa-check-circle"></i> مكتمل
                            </span>
                        </div>
                    }
                    @if (!Model.Lessons.Any())
                    {
                        <p class="text-muted text-center">لا توجد دروس متاحة حاليًا</p>
                    }
                </div>
            </div>
        </div>
    </div>
    <button class="theme-toggle" id="themeToggle">
        <i class="fas fa-moon"></i>
    </button>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        const themeToggle = document.getElementById('themeToggle');
        const body = document.body;

        function toggleTheme() {
            const isDark = body.classList.toggle('dark-mode');
            themeToggle.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        const savedTheme = localStorage.getItem('theme') || 'light';
        if (savedTheme === 'dark') {
            body.classList.add('dark-mode');
            themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
        }
        themeToggle.addEventListener('click', toggleTheme);

        let currentLessonId = null;
        document.querySelectorAll('.lesson-card').forEach(card => {
            card.addEventListener('click', function () {
                const videoUrl = this.dataset.video;
                const videoContainer = document.querySelector('.video-container');
                videoContainer.innerHTML = `<iframe src="${videoUrl}?autoplay=1" allowfullscreen></iframe>`;

                document.querySelectorAll('.lesson-card').forEach(c => c.classList.remove('active'));
                this.classList.add('active');

                const lessonId = this.dataset.id;
                currentLessonId = lessonId;

                fetch('/Payment/MarkLessonCompleted', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lessonId: lessonId, courseId: '@Model.CourseId' })
                }).then(response => response.json()).then(data => {
                    if (data.success) {
                        this.querySelector('.completed-badge').classList.remove('d-none');
                        if (data.certificateUrl) {
                            alert('تهانينا! تم إصدار شهادتك.');
                            window.location.href = data.certificateUrl;
                        }
                    }
                });

                const quizBtn = document.getElementById('quizBtn');
                quizBtn.style.display = 'block';
            });
        });

        function takeQuiz() {
            if (currentLessonId) {
                window.location.href = `/Quiz/TakeQuiz?lessonId=${currentLessonId}`;
            }
        }

        function openNotes() {
            window.location.href = `/Notes?courseId=@Model.CourseId`;
        }
    </script>
</body>
</html>

@functions {
    private static string GetEmbedUrl(string url)
    {
        if (string.IsNullOrEmpty(url)) return "";
        if (url.Contains("youtu.be"))
        {
            var videoId = url.Split('/').Last().Split('?').First();
            return $"https://www.youtube.com/embed/{videoId}";
        }
        if (url.Contains("watch?v="))
        {
            var videoId = url.Split('=').Last().Split('&').First();
            return $"https://www.youtube.com/embed/{videoId}";
        }
        return url;
    }
}